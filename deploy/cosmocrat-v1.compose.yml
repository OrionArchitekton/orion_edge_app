version: "3.9"

x-common-env: &common-env
  TZ: America/Los_Angeles

services:
  traefik:
    image: traefik:v2.11
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
    ports:
      - "80:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - traefik.enable=true
      - traefik.http.routers.dashboard.rule=Host(`ops.localhost`) && PathPrefix(`/traefik`)
      - traefik.http.routers.dashboard.service=api@internal
    restart: unless-stopped

  postgres:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_DB: cosmocrat
      POSTGRES_USER: cosmocrat
      POSTGRES_PASSWORD: change-me
    volumes:
      - pg_data:/var/lib/postgresql/data
    labels:
      - traefik.enable=false
    restart: unless-stopped

  redis:
    image: redis:7
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    labels:
      - traefik.enable=false
    restart: unless-stopped

  langfuse:
    image: ghcr.io/langfuse/langfuse:latest
    environment:
      <<: *common-env
      NEXT_PUBLIC_SIGNUP_DISABLED: "true"
      DATABASE_URL: postgresql://cosmocrat:change-me@postgres:5432/cosmocrat
      NEXTAUTH_URL: http://ops.localhost/langfuse
      NEXTAUTH_SECRET: replace-me
      SALT: replace-me
    depends_on: [postgres]
    labels:
      - traefik.enable=true
      - traefik.http.routers.langfuse.rule=Host(`ops.localhost`) && PathPrefix(`/langfuse`)
      - traefik.http.middlewares.langfuse-strip.stripprefix.prefixes=/langfuse
      - traefik.http.routers.langfuse.middlewares=langfuse-strip
      - traefik.http.services.langfuse.loadbalancer.server.port=3000
    restart: unless-stopped

  n8n:
    image: n8nio/n8n:latest
    environment:
      <<: *common-env
      N8N_BASIC_AUTH_ACTIVE: "true"
      N8N_BASIC_AUTH_USER: admin
      N8N_BASIC_AUTH_PASSWORD: change-me
      N8N_HOST: ops.localhost
      N8N_PORT: 5678
    labels:
      - traefik.enable=true
      - traefik.http.routers.n8n.rule=Host(`ops.localhost`) && PathPrefix(`/n8n`)
      - traefik.http.middlewares.n8n-strip.stripprefix.prefixes=/n8n
      - traefik.http.routers.n8n.middlewares=n8n-strip
      - traefik.http.services.n8n.loadbalancer.server.port=5678
    volumes:
      - n8n_data:/home/node/.n8n
    restart: unless-stopped

  vllm:
    image: vllm/vllm-openai:latest
    command: ["--model", "mistralai/Mistral-7B-Instruct-v0.3", "--port", "8000"]
    shm_size: "4gb"
    labels:
      - traefik.enable=true
      - traefik.http.routers.vllm.rule=Host(`ops.localhost`) && PathPrefix(`/vllm`)
      - traefik.http.middlewares.vllm-strip.stripprefix.prefixes=/vllm
      - traefik.http.routers.vllm.middlewares=vllm-strip
      - traefik.http.services.vllm.loadbalancer.server.port=8000
    restart: unless-stopped

  mcp:
    build:
      context: ./app/mcp
      dockerfile: Dockerfile
    environment:
      <<: *common-env
      POSTGRES_URL: postgresql://cosmocrat:change-me@postgres:5432/cosmocrat
      REDIS_URL: redis://redis:6379/0
      LANGFUSE_BASE_URL: http://langfuse:3000
      LANGFUSE_API_KEY: replace-me
      VLLM_BASE_URL: http://vllm:8000/v1
    depends_on: [postgres, redis, langfuse, vllm]
    labels:
      - traefik.enable=true
      - traefik.http.routers.mcp.rule=Host(`mcp.localhost`)
      - traefik.http.services.mcp.loadbalancer.server.port=8080
    restart: unless-stopped

  memory-consolidator:
    image: python:3.11-slim
    volumes: ["./jobs/memory:/app"]
    environment:
      <<: *common-env
      POSTGRES_URL: postgresql://cosmocrat:change-me@postgres:5432/cosmocrat
      LANGFUSE_BASE_URL: http://langfuse:3000
      LANGFUSE_API_KEY: replace-me
    command: ["bash", "-lc", "pip install requests psycopg[binary] && python /app/consolidate.py && while true; do sleep 86400; python /app/consolidate.py; done"]
    depends_on: [postgres, langfuse]
    restart: unless-stopped

volumes:
  pg_data:
  redis_data:
  n8n_data:
